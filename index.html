<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monolith</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
      body {
        margin: 0;
        font-family: Consolas, monospace;
        background-color: #0a0f1e;
        color: #ffffff;
        overflow: hidden;
      }

      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 70px;
        background-color: #111d3d;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); /* sombra vertical com suavidade */
        z-index: 10;
      }

      .title {
        font-size: 30px;
        font-weight: bold;
        text-align: center;
        flex: 1;
        color: white;
        transition: color 0.3s ease, filter 0.3s ease;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      .actions button, .exportBtn {
        background-color: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 6px 8px;
        margin-left: 6px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease;
      }

      .actions button:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .dropdown-wrapper {
        position: relative;
      }

      .dropdown {
        position: absolute;
        top: 110%;
        left: -12px;
        background: #1a1a1a;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 4px;
        display: flex;
        flex-direction: column;
        z-index: 100;
      }

      .dropdown button {
        padding: 5px 10px;
        background: transparent;
        border: none;
        color: white;
        text-align: left;
        cursor: pointer;
      }

      .dropdown button:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .editor-container {
        position: absolute;
        top: 60px;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      }

      .line {
        display: flex;
      }

      .line-number {
        width: 40px;
        text-align: right;
        padding-right: 15px;
        user-select: none;
        color: #778da9;
      }

      .line-content {
        flex: 1;
        white-space: pre-wrap;
        word-break: break-word;
        outline: none;

      }

      .progress-container {
        position: absolute;
        top: 50%;
        left: 30px;
        transform: translateY(-50%);
        width: 50px;
        height: 50px;
      }

      .progress-ring {
        transform: rotate(-90deg);
      }

      .progress-ring circle {
        fill: none;
        stroke-width: 2;
      }

      .progress-ring .bg {
        stroke: white;
      }

      .progress-ring .progress {
        stroke: gold;
        stroke-linecap: round;
        filter: drop-shadow(0 0 2px gold);
        stroke-width: 3;
        transition: stroke-dashoffset 0.5s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 16px;
        pointer-events: none;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }

      .modal-content {
        background-color: #1c1f2b;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        color: white;
        text-align: center;
        box-shadow: 0 0 10px rgba(255,255,255,0.2);
      }

      .close {
        position: absolute;
        top: 12px;
        right: 20px;
        color: white;
        font-size: 24px;
        cursor: pointer;
      }

      .emoji-panel {
        position: absolute;
        top: 57px;
        right: 10px;
        background-color: #1c1f2b;
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 6px;
        padding: 10px;
        display: flex;
        gap: 8px;
        z-index: 100;
      }

      .emoji-panel span {
        cursor: pointer;
        font-size: 18px;
      }

      .export-menu {
        position: relative;
        display: inline-block;
      }

      .exportOptions {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: #1e1e2f;
        border: 1px solid #ccc;
        z-index: 100;
        display: flex;
        flex-direction: column;
      }

      .exportOptions button {
        background: none;
        border: none;
        color: white;
        padding: 8px;
        text-align: left;
        cursor: pointer;
      }

      .exportOptions button:hover {
        background-color: #333c;
      }

      .task-checkbox {
          /* Estilo b√°sico para o checkbox */
          -webkit-appearance: none; /* Esconde o checkbox padr√£o no WebKit */
          -moz-appearance: none;    /* Esconde o checkbox padr√£o no Firefox */
          appearance: none;         /* Esconde o checkbox padr√£o */

          display: inline-block;
          width: 22px; /* Largura do "bot√£o" */
          height: 22px; /* Altura do "bot√£o" */
          vertical-align: middle; /* Alinha o checkbox verticalmente com o texto */
          border: 2px solid #aaa; /* Borda do "bot√£o" */
          border-radius: 6px; /* Cantos arredondados */
          background-color: #333d; /* Cor de fundo padr√£o */
          cursor: pointer;
          margin-right: 4px; /* Espa√ßo entre o checkbox e o texto */
          box-sizing: border-box; /* Inclui padding e border na largura/altura */
          flex-shrink: 0; /* Impede que ele encolha em layouts flexbox */

          transition: background-color 0.5s ease, border-color 0.5s ease;
          position: relative;
      }

      .task-checkbox:checked {
          background-color: #11c21b; /* Cor de fundo quando marcado (verde) */
          border-color: #31a337;
      }

      .task-checkbox::after {
          content: '‚úî'; /* √çcone de check */
          display: block;
          color: white;
          font-size: 14px;
          line-height: 1; /* Garante que o √≠cone se ajuste verticalmente */
          text-align: center;
          position: relative;
          top: 2px; /* Ajuste fino da posi√ß√£o do check */
          left: 1px;

          opacity: 0;
          transform: scale(0.5);
          transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .task-checkbox:checked::after {
          opacity: 1;
          transform: scale(1);
      }

      .task-checkbox:hover {
          filter: brightness(1.2); /* Pequeno brilho ao passar o mouse */
      }

      .hidden {
        display: none;
      }

      /* Para navegadores baseados em WebKit (Chrome, Edge, Safari) */
      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        background: #1a1f2e; /* Fundo da barra, azul escuro */
      }

      ::-webkit-scrollbar-thumb {
        background-color: #ffaa00; /* Cor do "bot√£o" da barra (amarelo ouro) */
        border-radius: 10px;
        border: 2px solid #1a1f2e; /* Borda para dar profundidade */
      }

      /* Para Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: #ffaa00 #1a1f2e;
      }

    </style>
  </head>
  <body>
    <header>
      <div class="progress-container">
        <svg class="progress-ring" width="50" height="50">
          <circle class="bg" cx="25" cy="25" r="22" />
          <circle class="progress" cx="25" cy="25" r="22" stroke-dasharray="138" stroke-dashoffset="138" />
        </svg>
        <div class="progress-text">0</div>
      </div>

      <div class="title">Monolith</div>

      <div class="actions">
        <button onclick="formatText('bold')"><i class="fas fa-bold"></i></button> <!-- <- Aqui altera para o √≠cone "B" -->
        <button onclick="formatText('italic')"><i class="fas fa-italic"></i></button> <!-- <- Aqui altera para o √≠cone "I" -->
        <button onclick="formatText('underline')"><u>U</u></button> <!-- <- Aqui altera para o √≠cone "U" -->
        <button onclick="formatText('strikeThrough')"><i class="fas fa-strikethrough"></i></button>
        <button onclick="insertCheckbox()">‚úÖ</button>
        <button onclick="toggleEmojiPanel()">üôÇ</button>
        <button id="soundToggleBtn" onclick="toggleSound()">üîî</button>
        <div class="dropdown-wrapper">
          <button class="exportBtn" id="exportBtn" data-dropdown-target="exportOptions">üíæ</button> <div id="exportOptions" class="dropdown hidden">
            <button onclick="exportAs('txt')">.txt</button>
            <button onclick="exportAs('pdf')">.pdf</button>
            <button onclick="exportAs('docx')">.docx</button>
          </div>
        </div>
        <button onclick="toggleInfo()">‚ÑπÔ∏è</button>
      </div>
    </header>

    <div id="counterPopup" class="counter-popup hidden">
      <span>Contador aumentou para <span id="popupCount">0</span>!</span>
      <span id="popupEmoji" class="popup-emoji"></span>
    </div>

    <div class="editor-container" id="editor"></div>

    <script>
      const editor = document.getElementById("editor");

      editor.addEventListener("click", () => {
        editor.focus();
      });

      const progressCircle = document.querySelector(".progress-ring .progress");
      const progressText = document.querySelector(".progress-text");
      const radius = 22;
      const circumference = 2 * Math.PI * radius;
      progressCircle.style.strokeDasharray = `${circumference}`;
      progressCircle.style.strokeDashoffset = `${circumference}`;

      function setProgress(percent) {
        const offset = circumference - (percent / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
      }

      function formatText(command) {
        document.execCommand(command, false, null);
        updateStorage();
      }

      function playPopSound() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // ========= Componente tonal (grave e curto) =========
        const osc = audioCtx.createOscillator();
        const oscGain = audioCtx.createGain();

        osc.type = "sine";
        osc.frequency.setValueAtTime(1550, audioCtx.currentTime);
        oscGain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        oscGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);

        osc.connect(oscGain);
        oscGain.connect(audioCtx.destination);

        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);

        // ========= Componente de ru√≠do (estalo grave) =========
        const bufferSize = audioCtx.sampleRate * 0.06; // 60ms
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const output = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          output[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 2);
        }

        const noise = audioCtx.createBufferSource();
        noise.buffer = buffer;

        const noiseFilter = audioCtx.createBiquadFilter();
        noiseFilter.type = "bandpass";
        noiseFilter.frequency.setValueAtTime(600, audioCtx.currentTime); // ‚Üì antes era 1000
        noiseFilter.Q.setValueAtTime(8, audioCtx.currentTime); // um pouco mais largo

        const noiseGain = audioCtx.createGain();
        noiseGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        noiseGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);

        noise.connect(noiseFilter);
        noiseFilter.connect(noiseGain);
        noiseGain.connect(audioCtx.destination);

        noise.start();
        noise.stop(audioCtx.currentTime + 0.07);
      }

      let isSoundOn = true;
      let Sound_effect=1

      function toggleSound() {
        isSoundOn = !isSoundOn; // inverte o estado
        const btn = document.getElementById("soundToggleBtn");
        btn.textContent = isSoundOn ? "üîî" : "üîï";

        if (isSoundOn) {
          console.log("Som ligado");
          Sound_effect=1
        } else {
          console.log("Som desligado");
          Sound_effect=0
        }
      }

      function createLine(content = "") {
        const line = document.createElement("div");
        line.className = "line";

        const lineNumber = document.createElement("div");
        lineNumber.className = "line-number";

        const lineContent = document.createElement("div");
        lineContent.className = "line-content";
        lineContent.contentEditable = true;
        lineContent.innerHTML = content;

        line.appendChild(lineNumber);
        line.appendChild(lineContent);
        return line;
      }

      function updateLineNumbers() {
        const lines = Array.from(editor.children);
        let realLine = "->";
        lines.forEach((line, idx) => {
          const content = line.querySelector(".line-content").innerText.trim();
          if (content === "" && idx === lines.length - 1) {
            editor.removeChild(line);
          } else {
            line.querySelector(".line-number").textContent = realLine;
          }
        });

        if (editor.children.length === 0) {
          editor.appendChild(createLine());
        }
      }

      const popup = document.getElementById("counterPopup");
      const popupCountSpan = document.getElementById("popupCount");
      const popupEmojiSpan = document.getElementById("popupEmoji");
      let lastNotifiedCharCount = 0;
      let popupTimeout;
      let last_score = 0;

      function updateProgress() {
        const content = Array.from(editor.querySelectorAll(".line-content")).map(l => l.innerText).join("\n");
        const charCount = content.length;
        const percent = (charCount % 100) / 100 * 100;
        setProgress(percent);
        const title = document.querySelector(".title");

        const score = Math.floor(charCount / 100);

        progressText.textContent = score >= 10000 ? "+" : score;

        if (score != last_score) {
          last_score=score
          if (Sound_effect === 1){
            playPopSound()
          }
        }

        title.style.color = `white`;

        if (score > 0) {
          const glow = Math.min(score / 400, 1) * 1.5;
          title.style.filter = `drop-shadow(0 0 ${4 * glow}px rgba(140, 0, 255, 0.5))`;
        } else {
          title.style.filter = "none";
        }
      }

      function updateStorage() {
        const lines = Array.from(editor.querySelectorAll(".line-content")).map(l => l.innerHTML);
        localStorage.setItem("monolith", JSON.stringify(lines));
        updateLineNumbers();
        updateProgress();
      }

      function loadFromStorage() {
        const saved = JSON.parse(localStorage.getItem("monolith") || "[]");
        if (saved.length > 0) {
          saved.forEach(content => editor.appendChild(createLine(content)));
        } else {
          editor.appendChild(createLine());
        }
        updateLineNumbers();
        updateProgress();
      }

      function insertCheckbox() {
          const selection = window.getSelection();
          if (!selection.rangeCount) return; // Garante que h√° uma sele√ß√£o ativa

          const range = selection.getRangeAt(0);
          const checkboxHtml = '<input type="checkbox" class="task-checkbox" contenteditable="false"> '; // O espa√ßo √© importante

          // Crie um DocumentFragment para inserir o HTML
          const fragment = range.createContextualFragment(checkboxHtml);

          range.deleteContents(); // Remove qualquer conte√∫do selecionado
          range.insertNode(fragment); // Insere o checkbox

          // Opcional: Mover o cursor para depois do checkbox
          range.collapse(false); // Colapsa o range para o final da inser√ß√£o
          selection.removeAllRanges();
          selection.addRange(range);

          updateStorage(); // Atualiza o armazenamento ap√≥s a inser√ß√£o
      }

      let savedRange = null;
      // Salva o range apenas se o foco estiver dentro do editor
      document.addEventListener("selectionchange", () => {
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
          const range = sel.getRangeAt(0);
          const editorContains = editor.contains(range.startContainer);
          if (editorContains) {
            savedRange = range.cloneRange();
          }
        }
      });

      document.getElementById("exportBtn").addEventListener("click", function(event) {
          const exportOptions = document.getElementById("exportOptions");
          exportOptions.classList.toggle("hidden");
          event.stopPropagation();
      });

      document.addEventListener("click", function (event) {
        const exportBtn = document.getElementById("exportBtn");
        const exportOptions = document.getElementById("exportOptions");
        const emojiPanel = document.getElementById("emojiPanel");
        const infoPanel = document.getElementById("infoPanel");

        // Se clicou fora do bot√£o ou do menu
        if (!exportOptions.classList.contains("hidden") && !exportBtn.contains(event.target) && !exportOptions.contains(event.target)) {
            exportOptions.classList.add("hidden");
        }

        const emojiButton = document.querySelector('.actions button[onclick="toggleEmojiPanel()"]');
        if (emojiButton && !emojiButton.contains(event.target) && !emojiPanel.contains(event.target)) {
            emojiPanel.classList.add("hidden");
        }

        const infoButton = document.querySelector('.actions button[onclick="toggleInfo()"]');
        if (infoButton && !infoButton.contains(event.target) && !infoPanel.contains(event.target)) {
            infoPanel.classList.add("hidden");
        }
      });

      function exportAs(type) {
        const content = Array.from(document.querySelectorAll(".line-content"))
          .map(line => line.innerText)
          .join("\n");

        const filename = "monolith";

        if (type === "txt") {
          const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
          downloadBlob(blob, filename + ".txt");
        }

        else if (type === "pdf") {
          const pdfWindow = window.open("", "", "width=800,height=600");
          pdfWindow.document.write(`<pre>${content}</pre>`);
          pdfWindow.document.close();
          pdfWindow.print(); // abre o modo de impress√£o com op√ß√£o de salvar em PDF
        }

        else if (type === "docx") {
          const html = `<html><head><meta charset="utf-8"></head><body><pre>${content}</pre></body></html>`;
          const blob = new Blob(['\ufeff', html], {
            type: "application/msword"
          });
          downloadBlob(blob, filename + ".docx");
        }

        document.getElementById("exportOptions").classList.add("hidden");
      }

      function downloadBlob(blob, filename) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function toggleInfo() {
        const panel = document.getElementById("infoPanel");
        panel.classList.toggle("hidden");
      }

      function toggleEmojiPanel() {
        const panel = document.getElementById("emojiPanel");
        panel.classList.toggle("hidden");
      }

      function toggleExportMenu() {
        const menu = document.getElementById("exportOptions");
        menu.classList.toggle("hidden");
      }

      function insertEmoji(emoji) {
        const sel = window.getSelection();
        let targetRange;

        if (!sel.rangeCount || !savedRange || !editor.contains(savedRange.startContainer)) {
            // Tenta obter o primeiro .line-content
            const firstLineContent = editor.querySelector(".line-content");
            if (firstLineContent) {
                targetRange = document.createRange();
                targetRange.selectNodeContents(firstLineContent); // Seleciona todo o conte√∫do da primeira linha
                targetRange.collapse(false); // Colapsa para o final da primeira linha
                sel.removeAllRanges();
                sel.addRange(targetRange);
                savedRange = targetRange.cloneRange(); // Atualiza savedRange tamb√©m
            } else {
                // Se n√£o h√° NENHUMA linha, cria uma e tenta novamente.
                // Isso n√£o deve acontecer se loadFromStorage sempre criar uma linha.
                editor.appendChild(createLine());
                const createdLineContent = editor.querySelector(".line-content");
                targetRange = document.createRange();
                targetRange.selectNodeContents(createdLineContent);
                targetRange.collapse(false);
                sel.removeAllRanges();
                sel.addRange(targetRange);
                savedRange = targetRange.cloneRange();
            }
        } else {
            // Se houver um savedRange v√°lido, use-o
            sel.removeAllRanges();
            sel.addRange(savedRange);
            targetRange = savedRange;
        }

        const node = document.createTextNode(emoji);
        targetRange.deleteContents(); // Remove qualquer conte√∫do selecionado (se houver)
        targetRange.insertNode(node); // Insere o emoji

        // Move o cursor ap√≥s o emoji inserido
        targetRange.setStartAfter(node);
        targetRange.setEndAfter(node);
        sel.removeAllRanges();
        sel.addRange(targetRange);

        // Opcional: Refor√ßa o foco no editor se ele n√£o estiver focado
        const focusNode = sel.focusNode;
        if (focusNode && focusNode.nodeType === Node.TEXT_NODE) {
          const parent = focusNode.parentElement;
          if (parent && parent.closest(".line-content")) {
            parent.focus();
          }
        } else if (focusNode && focusNode.closest(".line-content")) {
            focusNode.focus();
        }

        document.getElementById("emojiPanel").classList.add("hidden");
        updateStorage(); // Atualiza o armazenamento ap√≥s a inser√ß√£o
      }

      editor.addEventListener("input", updateStorage);

      editor.addEventListener("keydown", e => {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        const range = selection.getRangeAt(0);
        const currentLine = selection.anchorNode.closest(".line-content");

        if (e.key === "Enter") {
          e.preventDefault();
          const newLine = createLine();
          editor.insertBefore(newLine, currentLine.parentElement.nextSibling);
          updateLineNumbers();

          const newRange = document.createRange();
          newRange.selectNodeContents(newLine.querySelector(".line-content"));
          newRange.collapse(true);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(newRange);
        } else if (e.key === "Backspace") {
          const isEmpty = currentLine.innerText.trim() === "";
          const isFirst = currentLine.parentElement === editor.firstChild;
          if (isEmpty && !isFirst) {
            e.preventDefault();
            const prev = currentLine.parentElement.previousSibling;
            const prevContent = prev.querySelector(".line-content");
            const content = prevContent.innerHTML + currentLine.innerHTML;
            prevContent.innerHTML = content;
            editor.removeChild(currentLine.parentElement);
            updateLineNumbers();

            const newRange = document.createRange();
            newRange.selectNodeContents(prevContent);
            newRange.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(newRange);
          }
        }
      });

      loadFromStorage();
    </script>

    <!-- Painel de Informa√ß√µes -->
    <div id="infoPanel" class="modal hidden">
      <div class="modal-content">
        <span onclick="toggleInfo()" class="close">&times;</span>
        <h2>Monolith</h2>
        <p>'The gods spun the ruin of men so that poems might be generated for posterity' - Homero</p>
        <br><p>The progress counter increments every 100 characters typed.</p>
        <p><br><i>Developed by Renan Costa<br>@MonolithWords</i><br>
        </p>
      </div>
    </div>

    <!-- Painel de Emojis -->
    <div id="emojiPanel" class="emoji-panel hidden">
      <span onclick="insertEmoji('‚úÖ')">‚úÖ</span>
      <span onclick="insertEmoji('‚ùå')">‚ùå</span>
      <span onclick="insertEmoji('üî•')">üî•</span>
      <span onclick="insertEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span onclick="insertEmoji('‚≠ê')">‚≠ê</span>
      <span onclick="insertEmoji('üí°')">üí°</span>
      <span onclick="insertEmoji('üåé')">üåé</span>
      <span onclick="insertEmoji('üìç')">üìç</span>
      <span onclick="insertEmoji('‚ö†Ô∏è')">‚ö†Ô∏è</span>
      <span onclick="insertEmoji('üéâ')">üéâ</span>
      <span onclick="insertEmoji('üòÄ')">üòÄ</span>
      <span onclick="insertEmoji('üòé')">üòé</span>
      <span onclick="insertEmoji('üòÇ')">üòÇ</span>
      <span onclick="insertEmoji('ü§î')">ü§î</span>
      <span onclick="insertEmoji('üòä')">üòä</span>
      <span onclick="insertEmoji('üòî')">üòî</span>
      <span onclick="insertEmoji('üò≠')">üò≠</span>
    </div>
  </body>
</html>